{"version":3,"sources":["gameMgr.js"],"names":["cc","Class","extends","Component","properties","mapMgr","require","propMgr","monsterMgr","bulletMgr","posMgr","effects","Node","players","type","Prefab","default","flag","onLoad","window","gm","offset","enableMapMove","currPlayer","instantiate","global","getPlayerId","playerScript","getComponent","init","schedule","readTime","EM","on","COLLSI_FLAG","collsiFlag","PLAYER_TO_END","playerToEnd","STOP_READTIME","unschedule","GAME_OVER","emit","CHANGE_STATE","FORM_STATE","SMALL","isOneOrTwo","getLife","restart","director","loadScene","nextPlayer","GAME_PASS","countTime","time","RISE_WRITE_FLAG","ADD_SCORE","ADD_TIME","update","dt","playerPos","node","convertToWorldSpace","position","x","getDie","interval","size","getSize","left","convertToNodeSpace","v2","width","y","right","winSize","hCurrSpeed","fixOffset","pos","worldPos","onDestroy","off"],"mappings":"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","file":"gameMgr.js","sourceRoot":"..\\..\\..\\..\\assets\\script","sourcesContent":["// Learn cc.Class:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/class.html\r\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/class.html\r\n// Learn Attribute:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\r\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/reference/attributes.html\r\n// Learn life-cycle callbacks:\r\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\r\n//  - [English] https://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        // foo: {\r\n        //     // ATTRIBUTES:\r\n        //     default: null,        // The default value will be used only when the component attaching\r\n        //                           // to a node for the first time\r\n        //     type: cc.SpriteFrame, // optional, default is typeof default\r\n        //     serializable: true,   // optional, default is true\r\n        // },\r\n        // bar: {\r\n        //     get () {\r\n        //         return this._bar;\r\n        //     },\r\n        //     set (value) {\r\n        //         this._bar = value;\r\n        //     }\r\n        // },\r\n        mapMgr:require(\"mapMgr\"),\r\n        propMgr:require(\"propMgr\"),\r\n        monsterMgr:require(\"monsterMgr\"),\r\n        bulletMgr:require(\"bulletMgr\"),\r\n        posMgr:require(\"posMgr\"),\r\n        effects:cc.Node,\r\n        players:\r\n        {\r\n            type:cc.Prefab,\r\n            default:[]   \r\n        },\r\n        flag:0,                         //人物移动到该点，地图移动，人物停止移动\r\n    },\r\n\r\n    // LIFE-CYCLE CALLBACKS:\r\n\r\n    onLoad () {\r\n        window.gm=this;\r\n        this.offset=0;\r\n        this.enableMapMove=true;\r\n        this.currPlayer=cc.instantiate(this.players[global.getPlayerId()]);\r\n        this.playerScript=this.currPlayer.getComponent(\"player\");\r\n        //global.init(1);\r\n        this.playerScript.init();\r\n        this.mapMgr.init(this.currPlayer);\r\n        this.monsterMgr.init();\r\n        this.propMgr.init();\r\n        this.posMgr.init();\r\n        //this.playerScript=this.currPlayer.getComponent(\"player\");\r\n        //this.node.addChild(this.currPlayer);\r\n\r\n        this.schedule(this.readTime,0.5);\r\n\r\n        EM.on(EM.type.COLLSI_FLAG,this.collsiFlag,this);\r\n        EM.on(EM.type.PLAYER_TO_END,this.playerToEnd,this);\r\n        EM.on(EM.type.STOP_READTIME,function(){\r\n            this.unschedule(this.readTime);\r\n        },this);\r\n\r\n        EM.on(EM.type.GAME_OVER,function(){\r\n            EM.emit(EM.type.CHANGE_STATE,FORM_STATE.SMALL);\r\n            if(global.isOneOrTwo()){\r\n                if(global.getLife()<0){\r\n                    global.restart();\r\n                    cc.director.loadScene(\"logo\");\r\n                }else{\r\n                    cc.director.loadScene(\"round\");\r\n                }\r\n            }else{\r\n                global.nextPlayer();\r\n                if(global.getLife()<0){\r\n                    global.nextPlayer();\r\n                    if(global.getLife()<0){\r\n                        global.restart();\r\n                        cc.director.loadScene(\"logo\");\r\n                    }else{\r\n                        cc.director.loadScene(\"round\");\r\n                    }\r\n                }else{\r\n                    cc.director.loadScene(\"round\");\r\n                }\r\n            }\r\n        },this);\r\n\r\n        EM.on(EM.type.GAME_PASS,function(){\r\n            cc.director.loadScene(\"round\");\r\n        },this);\r\n    },\r\n    playerToEnd(){\r\n        this.schedule(this.countTime,0.01);\r\n    },\r\n    countTime(){\r\n        if(global.time==0){\r\n            this.unschedule(this.countTime);\r\n            //next lv\r\n            EM.emit(EM.type.RISE_WRITE_FLAG);\r\n            return;\r\n        }\r\n        EM.emit(EM.type.ADD_SCORE,10);\r\n        EM.emit(EM.type.ADD_TIME,-1);\r\n    },\r\n    //读秒\r\n    readTime(){\r\n        if(global.time==0){\r\n            this.unschedule(this.readTime);\r\n            //next lv\r\n            //this.playerScript.fsm.switchState(\"die\");\r\n            return;\r\n        }\r\n        EM.emit(EM.type.ADD_TIME,-1);\r\n    },\r\n    collsiFlag(){\r\n        //玩家碰到旗帜，地图禁止移动，取消读秒\r\n        //this.enableMapMove=false;\r\n        this.unschedule(this.readTime);\r\n    },\r\n\r\n    update (dt) {\r\n        let playerPos=this.node.convertToWorldSpace(this.currPlayer.position);\r\n        //地图的移动检测\r\n        if(this.enableMapMove){\r\n            if(playerPos.x>this.flag+this.offset&&!this.playerScript.getDie()){\r\n                let interval=playerPos.x-this.flag-this.offset;\r\n                this.node.x-=interval;\r\n                //cc.log(interval.toFixed(2)+\":\"+dt.toFixed(4));\r\n                this.offset-=2;\r\n                if(this.offset<0)this.offset=0;\r\n            } \r\n        }\r\n \r\n        //人物与地图左边界的检测\r\n        let size=this.playerScript.getSize();\r\n        let left=this.node.convertToNodeSpace(cc.v2(size.width/2,size.y));\r\n        let right=this.node.convertToNodeSpace(cc.v2(global.winSize.width-size.width/2,size.y));\r\n        if(right.x<size.x){\r\n            this.playerScript.hCurrSpeed=0;\r\n            this.playerScript.node.x=right.x;\r\n        }else if(left.x>size.x){\r\n            this.playerScript.hCurrSpeed=0;\r\n            this.playerScript.node.x=left.x;\r\n        }\r\n    },\r\n    fixOffset(pos){\r\n        let worldPos=this.node.convertToWorldSpace(pos);\r\n        if(worldPos.x>this.flag){\r\n            this.offset=worldPos.x-this.flag;\r\n        }\r\n    },\r\n    onDestroy(){\r\n        EM.off(EM.type.COLLSI_FLAG);\r\n        EM.off(EM.type.PLAYER_TO_END);\r\n        EM.off(EM.type.STOP_READTIME);\r\n        EM.off(EM.type.GAME_OVER);\r\n        EM.off(EM.type.GAME_PASS);\r\n    }\r\n});\r\n"]}